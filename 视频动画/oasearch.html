<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>老oa查询外挂</title>
  <link rel="stylesheet" crossorigin="anonymous"
    href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.1/css/bootstrap.min.css">
  <link rel="stylesheet" crossorigin="anonymous"
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.1/animate.min.css">

  <link rel="stylesheet" crossorigin="anonymous"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.18.0/bootstrap-table.min.css">


  <link rel="stylesheet" crossorigin="anonymous"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.18.0/themes/bootstrap-table/bootstrap-table.min.css">

  <style>
    .glassbga {
      /*渐变*/
      background: linear-gradient(to right bottom, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.2));
      ;
      border-radius: 1rem;
      box-shadow: 6px 6px 10px rgba(112, 112, 112, 0.2);
    }

    .glassbg {
      /*背景*/
      background: linear-gradient(to right top, #65dfc9, #6cdbeb);
      border-radius: 1rem;
    }

    .center {
      position: absolute;
      left: 50%;
      top: 10%;
      transform: translate(-50%, -50%);
    }

    [v-cloak] {
      display: none;
    }
  </style>
</head>


<body id="q-app" class="glassbg text-white  ">
  <!---设置-->
  <div class="  d-none  d-sm-flex   fixed-top justify-content-end ">
    <span @click="pd.shwoChange=!pd.shwoChange " class="btn "
      style="font-size:32px;  filter: grayscale(100%); ">⚙</span>
  </div>






  <!---上面的结果框val--->
  <div v-cloak class="container ">
    <div class="mt-2 row justify-content-center  ">
      <div class="w-100 mb-5   d-none d-md-block"><!---高度垫子 小设备隐藏--></div>
      <div>
        <h3>oa基础数据查询</h3>
      </div>

    </div>
  </div>



  <!---齿轮设置-->
  <transition v-cloak enter-active-class="animated bounceIn" leave-active-class="animated bounceOut">
    <div v-if="pd.shwoChange==0?false:true" class="container-md     glassbga  mt-4  mb-4   pt-3  pb-3">
      <div class=" row  align-items-center   justify-content-around  ">
        <div class="  p-0 m-0 d-flex col-1 col-md-1 col-sm-1  justify-content-end  ">
          <label class="text-dark    mt-1       ">名字</label>
        </div>
        <div class="  p-0 m-0 col-6   col-md-4 col-sm-4   align-items-center  justify-content-start ">
          <input type="text" v-model="pd.searchName" class="  form-control">
        </div>

        <div class="   d-flex col-auto   justify-content-start  ">
          <button @click="er.emit('查询' ) " class="btn shadow-lg btn-danger">查询</button>
        </div>


      </div>


    </div>

  </transition>



  <!--功能选择--->
  <div v-cloak class="  container-md     glassbga  mt-4  mb-4   pt-3  pb-3  ">
    <div class="     justify-content-center  ">


      <ul class="nav nav-tabs   ">
        <li class="nav-item">
          <a class="nav-link shadow  bg-secondary  text-white  px-lg-5 mx-md-2 mx-lg-1   "
            :class="[{' active bg-info ': ('基本信息' == pd.tabSele )} ]">基本信息</a>
        </li>
        <li class="nav-item" id="prac">
          <a class="nav-link shadow   bg-secondary text-white  px-lg-5 mx-md-2 mx-lg-2"
            :class="[{' active bg-info ': ('请假' == pd.tabSele )} ]">请假</a>
        </li>
        <li class="nav-item" id="test">
          <a class="nav-link shadow   bg-secondary  text-white  px-lg-5 mx-md-2 mx-lg-2"
            :class="[{' active bg-info ': ('公出' == pd.tabSele )} ]">公出</a>
        </li>
        <li class="nav-item" id="test">
          <a class="nav-link shadow   bg-secondary  text-white  px-lg-5 mx-md-2 mx-lg-2"
            :class="[{' active bg-info ': ('补考勤' == pd.tabSele )} ]">补考勤</a>
        </li>
        <li class="nav-item" id="test">
          <a class="nav-link shadow   bg-secondary  text-white  px-lg-5 mx-md-2 mx-lg-2"
            :class="[{' active bg-info ': ('考勤' == pd.tabSele )} ]">考勤</a>
        </li>
      </ul>
      <table class="  bg-white" id="table"></table>
    </div>

  </div>




  <!---上面的结果框val--->
  <div v-cloak class="container-sm ">

    <div class="  row justify-content-center  ">


    </div>
  </div>



  <!---info提示信息--->
  <transition v-cloak mode="out-in" enter-active-class="animated pulse" leave-active-class="animated bounceOutRight">
    <div class=" container-sm  fixed-top    " style="z-index: 1083 ;" v-for="site in pd.info_list">
      <div class="alert  alert-warning alert-dismissible fade show" role="alert">
        <strong>{{site.type}}</strong>{{ site.info }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    </div>
  </transition>
  <!---遮罩1024--->
  <div v-cloak v-if="pd.sp==0?false:true" @click="er.emit('遮罩',0) " style="z-index: 1081  ;"
    class=" modal-backdrop show ">

  </div>
  <!---载入动画--->
  <transition v-cloak leave-active-class="animated fadeOut">
    <div v-if="pd.sp==0?false:true"
      class="center w-100 mt-5   row d-flex     align-items-center  justify-content-center  " style="z-index: 1082  ;">
      <div class="spinner-border   "></div>
    </div>
  </transition>




  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.47/vue.global.prod.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.2.0/lodash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/EventEmitter/5.2.8/EventEmitter.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.18.0/bootstrap-table.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.18.0/bootstrap-table-vue.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.18.0/locale/bootstrap-table-zh-CN.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/3.2.0/mustache.min.js"></script>
  <!---Mustache-->



  <script>
    const er = new EventEmitter //事件线
    const { onMounted, emits, createApp, ref, watch, computed } = Vue

    const gd = {};//全局数据 解决调用引用问题
    gd.reg = {} //组成类到全局调用
    gd.storage = {
      //本地浏览器 存取组件
      set(key, value, area) {
        key = area ? area + ':' + key : key;//分区域分区组
        localStorage.setItem(key, JSON.stringify(value));
      },
      get(key, area) {
        key = area ? area + ':' + key : key;//分区域分区组
        return JSON.parse(localStorage.getItem(key));
      },
      remove(key, area) {
        key = area ? area + ':' + key : key;//分区域分区组
        localStorage.removeItem(key);
      },
    }
    gd.pd = ref({});;//page data 页面元素引用"数据"
    //const pd = ref({ "load": [] }); //特殊变量，页面数据
    const pvs = gd.pd.value; //变量代理访问
    class pgui {
      /* 界面控制类 初始化界面默认值 */
      constructor(arg) {
        //初始（值）

        //--界面值
        gd.reg.ui = this//全局资源
        pvs.sp = 0; //遮罩路由 (0.无，1.名单，2.登入 ,3.管理)
        pvs.info_list = []//交互提示 {info:"2",type:"2"}
        pvs.dat = {}

        pvs.searchName = gd.storage.get('searchName') ? gd.storage.get('searchName') : '';//'默认查询名
        //--存储默认值
        pvs.shwoChange = gd.storage.get('shwoChange') ? gd.storage.get('shwoChange') : 1;//设置显示
        pvs.tabSele = gd.storage.get('tabSele') ? gd.storage.get('tabSele') : '基本信息';//'默认路径'
        //初始效果

        this.init();
      }

      init() {
        //初始（设置）
        //绑定事件

        er.on('遮罩', this.spto)


        er.on('show.base', this.showTab)
        //er.on('修改', this.toChange)

        er.on('查询', this.toSearch)

        //er.on('获取音标', this.toGetPh) //获取音标

      }
      toSearch() {
        const ui = gd.reg.ui
        const se = gd.reg.se
        if (!pvs.searchName) { return }

        gd.storage.set('searchName', pvs.searchName)


        // fetch(url, opt)
        //     .then(res => res.json())
        //     .catch(that.getErr)
        //     .then(dat => er.emit('更新.发音人完成', dat))
        //     ;
        //动画效果
        ui.loginLoading(1)
        ui.spto(1) //loading 
        er.emit('se.user')
        er.emit('se.kq')


      }


      showTab(n) {
        //跳转、翻页
        const that = gd.oui
        console.log("name=", pvs.searchName)
        // ID,NAME,DEFAULTDEPARTMENT

        pvs.dat.T_DEPARTMENT

        var rows = pvs.dat.T_USER//[]
        
        $('#table').bootstrapTable({
          data: rows,        // 表格数据来源
          classes: 'table table-hover',
          theadClasses: 'thead',
          sortStable: true,
          search: true,                      //是否显示表格搜索
          striped: true,                      //是否显示行间隔色
          pageList: [5, 10, 20, 30],//可选择单页记录数
          //showRefresh: true,//刷新按钮
          pageNumber: 1, //初始化加载第一页
          pagination: true,//是否分页
          sidePagination: 'client',//server:服务器端分页|client：前端分页
          pageSize: 4,//单页记录数


          columns: [{
            field: 'ID',
            title: '用户id'
          }, {
            sortable:true,
            field: 'NAME',
            title: '用户名'
            

          }, {
            field: 'DEFAULTDEPARTMENT',
            title: '部门id'
          }
            , {
            field: 'DEFAULTDEPARTMENT',
            title: '部门id'
          }]
        });



      }

      loginLoading(n) {
        //登入中效果
        pvs.loginLoding = n
      }
      spto(n) {
        //遮罩和二级界面
        /*切换界面*/
        pvs.sp = n
      }



      showInfo(info, type = '') {
        //结果提示信息 （数据驱动）
        //添加数据，来添加提示
        pvs.info_list.push({ "info": info, "type": type })
        //缺少动效
        setTimeout(function () { pvs.info_list.splice(0, 1); }, 4000);
      }


      watchPg(newValue, oldValue) {
        //watch
        console.log('gd pagedata 被修改')
        //console.log('gd pagedata 被修改\n', newValue, '\n', oldValue)
      }

    }

    class select {
      /* 界面控制类 初始化界面默认值 */
      constructor(arg) {
        //初始（值）

        //--界面值
        gd.reg.se = this//全局资源

        pvs.dat = {}

        //初始效果
        this.hd = { //请求头
          mode: 'cors',
          cache: 'no-cache',
          "headers": {
            'Content-Type': 'application/json'
          }
        }
        this.keys = [] //完成清单
        //数据配置
        this.dcfg = {
          "T_USER": {
            "@column": "ID,NAME,DEFAULTDEPARTMENT",
            "NAME": '蔡金凯',
            "@limit": 1
          }
        }
        this.knum = _.keys(this.dcfg).length; //完成清单

        this.init();
      }

      init() {
        //初始（设置）
        //绑定事件
        er.on('se.user', this.seUser)
        er.on('se.dep', this.seDep)
        er.on('se.kq', this.seKq)

        er.on('se.kq_list', this.seKqList)


        er.on('bd', this.binding)
        er.on('getErr', this.getErr)


        er.on('se.补考勤', this.补考勤)
        er.on('se.请假', this.请假)

        er.on('se.公出', this.公出)

      }

      公出() {
        //moment().subtract(2, 'month').format('YYYY-MM')
        const ui = gd.reg.ui
        const se = gd.reg.se
        //查询考勤
        var userid = pvs.dat.T_USER[0]['ID']
        var vn = {
          "AUTHOR": userid
          , "ITEM_TRAVEL_OT&": ">" + moment().subtract(2, 'month').format('YYYY-MM') + '-01'
          , "@order": "-CREATED"
          , "@column": "AUTHOR,ITEM_TRAVEL_ST,ITEM_TRAVEL_OT,ITEM_TRAVEL_R.理由, ITEM_TRAVEL_CITY.公出城市, FORMNAME.模块,STATELABELINFO"
          , "#url": "http://127.0.0.1:2022/jsonapi/get"

        }



        var url = "http://127.0.0.1:2022/jsonapi/get";

        // //发送
        se.se("TLK_BUSINESS_PUBLIC_TRIP", vn, url, 'TLK_BUSINESS_PUBLIC_TRIP', '公出')


      }


      请假() {
        //moment().subtract(2, 'month').format('YYYY-MM')
        const ui = gd.reg.ui
        const se = gd.reg.se
        //查询考勤
        var userid = pvs.dat.T_USER[0]['ID']
        var vn = {
          "AUTHOR": userid
          , "ITEM_LEAVE_T&": ">" + moment().subtract(2, 'month').format('YYYY-MM') + '-01'
          , "@order": "-CREATED"
          , "@column": "AUTHOR, ITEM_START_T.开始事件,ITEM_LEAVE_T.结束事件,ITEM_LEAVE_R.理由,   ITEM_TITLE.模块,ITEM_APPLICANT"
        }



        var url = "http://127.0.0.1:2022/jsonapi/get";

        // //发送
        se.se("TLK_APPLY_LEAVE", vn, url, 'TLK_APPLY_LEAVE', '请假')


      }
      补考勤() {
        //moment().subtract(2, 'month').format('YYYY-MM')
        const ui = gd.reg.ui
        const se = gd.reg.se
        //查询考勤
        var userid = pvs.dat.T_USER[0]['ID']
        var vn = {
          "AUTHOR": userid
          , "ITEM_ATTDATE&": ">" + moment().subtract(2, 'month').format('YYYY-MM') + '-01'
          , "@order": "-CREATED"
          , "@column": "ITEM_ATTDATE, FORMNAME,AUTHOR"
        }

        var url = "http://127.0.0.1:2022/jsonapi/get";

        // //发送
        se.se("TLK_ATTENDANCEDETAIL", vn, url, 'TLK_ATTENDANCEDETAIL', '补考勤')

      }


      seKqList() {
        //moment().subtract(2, 'month').format('YYYY-MM')
        const ui = gd.reg.ui
        const se = gd.reg.se
        //查询考勤
        var kqid = pvs.dat.USERINFO[0]['考勤id']
        var kq = {
          "@column": "USERID,CHECKTIME",
          "USERID": kqid
          , 'CHECKTIME&': ">" + moment().subtract(2, 'month').format('YYYY-MM') + '-01'
          , "@order": "-CHECKTIME"
        }
        var url = "http://127.0.0.1:2044/jsonapi/get";

        // //发送
        se.se("CHECKINOUT", kq, url, 'CHECKINOUT', '考勤记录')

      }

      seKq() {
        const ui = gd.reg.ui
        const se = gd.reg.se
        //查询考勤
        var kq = {
          "@column": "BADGENUMBER.用户id,NAME,USERID.考勤id,DEFAULTDEPTID",
          "NAME": '蔡金凯',
          "@limit": 1
        }
        var url = "http://127.0.0.1:2044/jsonapi/get";
        // //发送
        se.se("USERINFO", kq, url, 'USERINFO', '考勤信息', 'se.kq_list')


      }
      seDep() {
        const ui = gd.reg.ui
        const se = gd.reg.se
        //查询部门

        //获取数据，发送请求
        var url = "http://127.0.0.1:2022/jsonapi/get";
        // //发送
        //return
        var depid = pvs.dat.T_USER[0]['DEFAULTDEPARTMENT']
        var oaUser = {
          "@column": "ID,NAME",
          "ID": depid,
          "@limit": 1
        }
        se.se("T_DEPARTMENT", oaUser, url, 'T_DEPARTMENT', '用户部门')


        console.log('seDep')
      }
      seUser() {
        const ui = gd.reg.ui
        const se = gd.reg.se
        //查询用户
        var oaUser = {
          "@column": "ID,NAME,DEFAULTDEPARTMENT",
          "NAME": '蔡金凯',
          "@limit": 1
        }
        //获取数据，发送请求
        var url = "http://127.0.0.1:2022/jsonapi/get";
        // //发送
        //return
        se.se("T_USER", oaUser, url, 'T_USER', '用户信息', ['se.dep', 'se.补考勤', 'se.请假', 'se.公出', 'show.base'])



      }
      binding(dat, name, info, next = '') {
        //数据收集挂在到dat
        const ui = gd.reg.ui
        const se = gd.reg.se
        //数据挂在到dat
        //console.log('binding==', name, info)
        ui.loginLoading(0)
        ui.spto(0)
        if (dat.data['@code'] < 300) {
          ui.showInfo(dat.data['@msg'], info)
          pvs.dat[name] = dat.data[name]
          if (dat.data[name].length > 0) {
            console.log(info + '==', dat.data[name][0])
          } else {
            console.log(name, info, '无上数据')
          }

          //
          if (_.isString(next)) { er.emit(next) } //下一步事件
          if (_.isArray(next)) { _.map(next, (n) => { er.emit(n) }) } //下一步事件
        } else {
          ui.showInfo('出现错误', info)
          console.log('出现错误', info + '==', dat)
        }
      }
      se(tab, dt, url, name, info, next = '') {
        //单发送请求
        const se = gd.reg.se
        var vn = {}
        vn[tab] = dt
        axios.post(url + '?' + tab, vn, se.hd)
          .then(dat => {
            er.emit('bd', dat, name, info, next)
          })
          .catch(err => {
            er.emit(err, name, info)
          })
      }
      getErr(error, naem, info) {
        //请求错误处理
        const ui = gd.reg.ui
        const se = gd.reg.se
        console.log('Error:', error, naem);
        ui.loginLoading(0) //loading 
        ui.spto(0) //loading  
        ui.showInfo('无法加载到数据，刷新重试', info) //loading  
      }
    }

    //----------开始
    let appdat = {
      setup() {
        const oui = new pgui(); //界面更改"方法"
        const se = new select(); //界面更改"方法"
        //const ocls = new cls(12);//默认选择
        //---放入全局解决this问题
        //gd.ocls = ocls; //抽奖类
        //gd.oin = oin; //通信逻辑
        gd.oui = oui; //ui界面

        watch(gd.pd, oui.watchPg, { deep: true });
        //pvs.opList = computed(() => oui.showOp('', '')); //二次计算pvs.opList
        //------

        //onMounted(() => ocls.bindEvt()); //窗口大小变动事件
        //onMounted(() => oui.remount()); //已经登入刷新处理
        onMounted(() => oui.toSearch(0)); //已经登入刷新处理
        //--变量关联到html的映射 js访问要加.value
        return { er, "pd": gd.pd, "ref_login_manage": gd.pd.refManageEmt, }
      }
    }
    const app = createApp(appdat)
    //app.use(Quasar) //vue的ui
    app.mount('#q-app')
  </script>



</body>

</html>