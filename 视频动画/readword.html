<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="description" content="单词浏览">
    <meta name="keywords" content="单词浏览,单词浏览">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>单词浏览</title>
    <link rel="stylesheet" crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css">
 
    <style>
        .glassbga {
            /*渐变*/
            background: linear-gradient(to right bottom, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.2));
            ;
            border-radius: 1rem;
            box-shadow: 6px 6px 10px rgba(112, 112, 112, 0.2);
        }

        .glassbg {
            background: linear-gradient(to right top, #65dfc9, #6cdbeb);
            border-radius: 1rem;
        }

        .circle-ab {
            background: linear-gradient(to right bottom, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.2));
            height: 14rem;
            width: 14rem;
            position: absolute;
            border-radius: 50%;
            opacity: 0.3;
        }

        .circle1 {
            top: 0%;
            right: 13%;
        }

        .circle2 {
            bottom: 6%;
            left: 13%;
        }
    </style>


</head>
<!--
    抽奖功能v1
    圆形排列
    8个人名
-->

<body id="q-app" class="glassbg text-white ">
    <!--悬浮球-->
    <div class="circle1 circle-ab"> </div>
    <div class="circle2 circle-ab"></div>
    <!---上面的结果框val--->
    <div class="container ">
        <div class="mt-1 row justify-content-center  ">
            <div class="w-100 mb-5   d-none d-md-block"><!---高度垫子 小设备隐藏--></div>
            <div :class="{'animate__animated  animate__bounceInUp':pd.showLucky}">
                <h3 v-text="ocls.refLucky.value">幸运儿</h3>
            </div>
        </div>
    </div>
    <!--抽奖盘-->
    <div class=" container w-100  ">
        <div class=" row glassbga   align-items-center  justify-content-center " style="height: 400px;">
             
            <span class=" shadow    badge badge-light badge-pill"  >内部
            </span>
             <span class=" shadow    badge badge-light badge-pill"  >内部2
            </span>
        </div>
    </div>
    <!--底部按钮-->
    <div class="fixed-bottom row justify-content-center rounded  ">
        <div class=" row col-md-5 col-sm-8   bg-warning glassbga  justify-content-around ">
            <button @click="er.emit('遮罩',1) " class="btn shadow-lg shadow btn-danger">输入名单
                <span class="position-absolute badge badge-light badge-pill" v-text="pd.nameSize"> </span>
            </button>
            <button ref="ref_login_manage" @click="er.emit('读取.单词',this) " class="btn shadow-lg btn-danger">登入
            </button>
        </div>
        <div class="w-100 mb-5   d-none d-md-block"><!---高度垫子 小设备隐藏--></div>
    </div>
 
 
    <!---遮罩--->
    <div v-if="pd.sp==0?false:true" @click="er.emit('遮罩',0) "  style="z-index: 1040  ;" class=" modal-backdrop show "></div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.47/vue.global.prod.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.2/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/EventEmitter/5.2.8/EventEmitter.min.js"></script>
    


    <script>
        const er = new EventEmitter //事件线
        const { onMounted, emits, createApp, ref, watch, computed } = Vue
        
        const gd = {};//全局数据 解决调用引用问题
        const pd = ref({ "load": [] }); //特殊变量，页面数据
        gd.pd = pd;//page data 页面元素引用"数据"
        gd.storage = {
            //本地浏览器 存取组件
            set(key, value) {
                localStorage.setItem(key, JSON.stringify(value));
            },
            get(key) {
                return JSON.parse(localStorage.getItem(key));
            },
            remove(key) {
                localStorage.removeItem(key);
            },
        }

        class pgui {
            /* 界面控制类 初始化界面默认值 */
            constructor(arg) {
                this.pd = gd.pd //页面数据
                this.pd.value.load.unshift('pgui')//从开头添加一个值
                this.pd.value.sp = 0; //遮罩路由 (0.无，1.名单，2.登入 ,3.管理)
                this.init();
       
                this.initManage();
                //绑定事件
                er.on("读取.单词",this.getRow)
                er.on('收到.单词',this.signing)
                er.on('遮罩',this.spto)
            }
            init() {
                //初始效果
                this.pd.value.namesText = ''  //输入框值
                this.pd.value.startBut = false;//开始按钮状态
                this.pd.value.showLucky = 0;//显示动画
            }

            initManage() {
                //管理相关相关界面
                this.pd.value.manage = {};//相关数据
                this.pd.refManageEmt = ref(null);//登入/管理按钮元素
       
            }
            
            getRow(e){
                //console.log('getRow==',e,this.$refs,e.$refs)
                //获取数据，发送请求
                var url = "http://127.0.0.1:2028/jsonapi/get";
                //url = "http://127.0.0.1:2028/jsonapi";
                var ja = {}
                var data = {"单个词表":ja};
                ja['@limit'] = 1
                var opt = {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    body: JSON.stringify(data),
                    "headers": {
                        'Content-Type': 'application/json'
                    }
                }
                //发送
                fetch(url, opt)
                    .then(res => res.json())
                    .catch(this.signErr)
                    .then(dat=> er.emit('收到.单词',dat))
                    ;
                //动画效果
          
                gd.oui.loginLoading(0)

            }
            loginLoading(n) {
                //登入中效果
                this.pd.value.loginLoding = n
            }
            spto(n) {
                var that = gd.oin
                /*切换界面*/
                gd.pd.value.sp = n
                //清除提示
                gd.pd.value.login_info = ''
            }
            signErr(error) {
                //登入错误处理
                var that = gd.oin
                that.pd.value['login_info'] = "登入出现错误"
                console.log('Error:', error);
                gd.oui.loginLoading(1)   //loading
            }
            signing(dat) {
                console.log('Sign已经请求',dat);
                gd.oui.loginLoading(1) //loading 
                
            }

            change2manage() {
                //转向成管理
                this.pd.value.email = gd.storage.get('ue')
                var emt = this.pd.refManageEmt.value
                emt.innerHTML = "管理"
                emt.onclick = () => { gd.oui.spto(3) }
            }
            change2login() {
                //转向成登入
                var emt = this.pd.refManageEmt.value
                emt.innerHTML = "登入"
                emt.onclick = () => { gd.oui.spto(2) }
            }
  

            watchPg(newValue, oldValue) {
                //watch
                console.log('gd pagedata 被修改')
                //console.log('gd pagedata 被修改\n', newValue, '\n', oldValue)
            }
        }
        /**使用类**/
        class cls {
            static st = 0;//静态变量
            constructor(arg) {
                //入口构造函数
                this.pd = gd.pd //页面数据
                this.pd.value.load.unshift('cls')
                //----显示类变量
                this.refLucky = ref('幸运儿');//抽奖结果
                this.waitTimeList = []; //旋转次数
                //初始列表数据 (有初始化数据除外)
                //this.initNames()
            }
            initNames() {
                this.pIdx = 0; //当前选中人
                this.tsIndex = 0;//抽奖动画指向改编号
                this.nameList = [] //名单
                //生成名单
                this.pd.value.nameSize = 16  //名单数
                this.nameList = Array.from(
                    Array(this.pd.value.nameSize), (v, k) => { return '幸运儿' + k }
                );
                //默认使用的名单内
                let cfgNameText = gd.storage.get('useNames')//text
                if (!_.isEmpty(cfgNameText)) {
                    this.nameList = cfgNameText.split('\n')//list
                    this.pd.value.nameSize = this.nameList.length //名单数
                }
                //用于显示的名单
                this.pd.value.namesText = this.nameList.join('\n');
                //console.log('nameList==',this.nameList)
            }
            str2list(nameStr) {
                var nameList = nameStr.split('\n')
                //this.nameList.value = nameStr.split('\n')
                nameList = _.compact(nameList);//去空值
                nameList = _.filter(nameList
                    , obj => /[^\s]+/.test(obj));//去不可见
                console.log(nameList)
                return nameList
            }
            loadNames() {
                /*载入名单  */
                //获取文字 关联映射
                console.log(this.pd.value.namesText);
                this.pd.value['sp'] = 0
                this.nameList = this.str2list(this.pd.value.namesText)
                this.pd.value.nameSize = this.nameList.length
                this.luckyPos();//排列
            }
            random(min, max) {
                //随机数区间
                return Math.round(Math.random() * (max - min)) + min;
            }
            linspace(a, b, n) {
                // 线性填充 start = 0, stop = 100, num = 5
                if (typeof n === "undefined") n = Math.max(Math.round(b - a) + 1, 1);
                if (n < 2) {
                    return n === 1 ? [a] : [];
                }
                var i, ret = Array(n);
                n--;
                for (i = n; i >= 0; i--) {
                    ret[i] = (i * b + (n - i) * a) / n;
                }
                return ret;
            }
            logspace(a, b, n) {
                return this.linspace(a, b, n).map(function (x) { return Math.pow(10, x); });
            }
            // 开始抽奖动画
            showDoIt() {
                /*
                抽奖要分2套参数 多人和人少
                按时间停止 【跳动最少 66+a到b的随机数 】
                */
                // 
                let jumpNum = this.pd.value.nameSize < 8 ? 33 : 66;//人多人少
                jumpNum += this.random(0, this.pd.value.nameSize - 1)
                console.log('jumpNum=', jumpNum)
                //曲率  logspace 非线性时间列表
                this.waitTimeList = this.logspace(1, jumpNum / (jumpNum / 10), jumpNum);
                this.st = this.waitTimeList[this.waitTimeList.length - 1]
                //重新计算控制最后一条的时间（控制在1秒左右）
                this.waitTimeList = this.waitTimeList.map((ts) => {
                    return ts / this.st / 1.2
                })
                //重新计算控制，最慢切换时间
                this.waitTimeList = this.waitTimeList.map((ts) => {
                    //人多人少有区别
                    if (this.pd.value.nameSize < 8) {
                        return ts < 0.1 ? 0.1 : ts
                    } else {
                        return ts < 0.04 ? 0.04 : ts
                    }
                })
                //延迟调用
                this.tsIndex = 0;
                this.重复调用()
                this.pd.value.startBut = true; //禁用开始按钮
            }
            
            getElxy(el = null) {
                el = el ? el : this.pd.refPoint.value
                //计算某元素top、left坐标
                var top = 0, left = 0;
                var el_now = el //原生元素
                while (el_now.offsetParent !== null) {//到body 
                    top += el_now.offsetTop
                    left += el_now.offsetLeft
                    el_now = el_now.offsetParent
                }
                return { top, left } //位置之和
            }
            resize(e) {
                //重画
                console.log('component onresize!', gd, e);
                //gd.ocls.luckyPos()
            }
            bindEvt() {
                let resizeTimer = null;//免重复调用
                window.addEventListener('winResize', gd.ocls.resize);//绑定自定义事件
                window.onresize = () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        window.dispatchEvent(new CustomEvent('winResize', {})); //调度事件
                        console.log('component onresize!');
                    }, 50)
                }
            }
        }
        //----------开始
        let appdat = {
            setup() {
               
                const oui = new pgui(); //界面更改"方法"
                const ocls = new cls(12);//默认选择
                //-----放入全局解决this问题
                gd.ocls = ocls; //抽奖类
                //gd.oin = oin; //通信逻辑
                gd.oui = oui; //ui界面
                
                
                watch(pd, oui.watchPg, { deep: true });
                computed(() => { return JSON.parse(JSON.stringify(pd.value)); });
                //const oin = new login();
                
                
                onMounted(() => ocls.bindEvt()); //窗口大小变动事件
               
                //onMounted(() => oui.remount()); //已经登入刷新处理
                //变量到html的绑定 js访问要加.value
                return {er, pd,  oui, ocls, "ref_login_manage": pd.refManageEmt,  } 
            }
        }
        const app = createApp(appdat)
        //app.use(Quasar) //vue的ui
        app.mount('#q-app')
    </script>

 



</body>
</html>