 



## 软路由

软路由wrt接管大部分无线接入直接通往防火墙,加入ospf实现高级交换机功能。部分行为管理上网管控通过docker功能实现  ( ImmortalWrt v23 )

通过虚拟服务器+虚拟交换机

![](./imgs/软路由.png)



![](./imgs/wrt01.png)

 

### 接口

设备管理二层，接口管理三层  ，三层重点在于防火墙，二层重点在与vlan。wan口不具备任何路由功能（防火墙规则为丢弃）



#### uci查看配置

```
uci show network
```





#### 物理设备规划 

虚拟交换机通物理交换机 trunks

```
    Bridge ovs1
        Port vnet0
            Interface vnet0
        Port ovs1
            Interface ovs1
                type: internal
        Port eno2
            trunks: [15, 16, 17, 18, 19, 20, 21, 22]
            Interface eno2
        Port vnet1
            Interface vnet1
    ovs_version: "2.13.8"


```



#### 虚拟接口规划

所以接口都是虚拟化的要对应各种设备

配置设备后一般都需要指定防护墙区域，方便管理通信(无法连到端口,就是被防火墙挡住了)

### 路由表

路由表 是一个数字从0-65535， 表+规则完成不同情况走不同的路由

状体->路由--》IPv4 邻居：可以看到arp表

#### 静态 IPv4 路由

| 接口 | 目标      | 网关        | 跃点数 | 表   |
| ---- | --------- | ----------- | ------ | ---- |
| lan2 | 0.0.0.0/0 | 192.168.2.1 | 0      | 44   |

#### ipv4规则



| 优先级 | 传入接口 | 源地址            | 传出接口 | 目标地址 | 表   |
| ------ | -------- | ----------------- | -------- | -------- | ---- |
| 自动   | br-lan   | 192.168.99.0/24   | 未指定   | 任意     | 44   |
| 自动   | 未指定   | 192.168.99.199/32 | 未指定   | 任意     | 44   |

注意：当源地址为网段需要指定传入接口

#### 验证路由

```
tracert -d  112.16.172.14
```

结果

走电信路线

```
tracert -d  112.16.172.14

通过最多 30 个跃点跟踪到 112.16.172.14 的路由

  1     1 ms     1 ms     1 ms  192.168.20.12
  2     3 ms     1 ms     1 ms  192.168.2.1
  3     4 ms     3 ms     3 ms  192.168.1.1
  4     5 ms     4 ms     4 ms  125.115.232.1
  5    44 ms    16 ms     9 ms  115.233.65.145
```

走移动路线

```
tracert -d  112.16.172.14

通过最多 30 个跃点跟踪到 112.16.172.14 的路由

  1     3 ms     3 ms     3 ms  192.168.11.1
  2    <1 毫秒   <1 毫秒   <1 毫秒 112.16.172.14
```

## 流量控制eqos

可以通过ip限制 某电脑上网速度

## 交换机设置

access/trunk/Hybrid

Hybrid 最灵活

access 最稳定



旧版wrt

接口-》设备-》配置

![](./imgs/wrt02.png)

### vlan和ip对应

vlan20配置192.168.11.0/24  无法通行  (前提：通一个vlan后对应ip)





### 启用vlan

设备-》配置-》网桥vlan过滤：启用

vlan id 11 创建了blan.11接口一个，保存但是不应用。

### VLAN类型

(已打标签)T 类型  trunk   //T类型+主vlan  就能通 

(未打标签)U类型  Hybrid   //

![](./imgs/wrt02.2.png)

#### 主vlan

端口的默认vlan  一般不使用，发送的数据默认打上这个vlanid   







#### 修改mac地址 （kvm貌似无法实现）

blan.11 的mac地址可以自己定义 

### 使用vlan

接口-》添加新接口 -》软件VLAN: blan.11

![](./imgs/wrt03.png)



```
blan.11
```



##### 交换机端口 配置

```
interface Ethernet0/0/3
 port link-type trunk
 port trunk allow-pass vlan 2 to 111
```



### 基于vlan的路由

规则

![](./imgs/wrt04.png)

路由表

![](./imgs/wrt05.png)

## 路由协议frr-ospf

frr-ospfd / quagga-ospfd 比较老
frr-ospfd 更强大



```cmd
opkg install frr-zebra frr-staticd frr-watchfrr frr-ospfd frr-vtysh
```

配置文件 vi /etc/frr/daemons 修改部分

```
ospfd=yes
vtysh_enable=yes
```



### 命令vtysh

类似于交换机 ?提供帮助

#### 单行命令

```
vtysh  -c 'show ip route'
```

#### ospf配置

```
vtysh  -c ' show running-config ospfd'
```

4种状态

| 状态                 | 步骤        |      |
| -------------------- | ----------- | ---- |
| **· Down状态；**     | 离线        |      |
| **· Attempt状态；**  | 单向联络    |      |
| **· Init状态；**     | 收到hello   |      |
| **· 2-way状态；**    | 得到对方rid |      |
| **· Exstart状态；**  | 选举        |      |
| **· Exchange状态；** | 开始交换    |      |
| **· Loading状态；**  | 交互路由表  |      |
| **· Full状态。**     | 完成交换    |      |



3种角色

DR指定路由，BDR备选路由，DROther其他路由



#### 查看

命令行 vtysh

```cmd
show int brief
show interface brief

show run
show ip route

```

#### 查看ospf细节

#### 查看相邻

```
show ip ospf    
show ip ospf neighbor #邻居 
show ip ospf route
 show ip ospf int
```

OSPF邻居状态详解





#### 查看路由

```
show ip ospf route
```



#### 配置 表

```
configure  terminal
router ospf
ospf router-id 200.200.22.101
network 192.168.17.0/24 area 123  #同有网段
default-information originate #下发默认路由
do write file
```

##### rid

```
主优先级.次优先级.网段.ip地址
```



#### 删除命令

```
no network 192.168.20.0/24 area 0

```



### 监控数据包

通过抓包查看通信内容

```
tcpdump -vvv proto ospf
```







## 网络异常分析

softflowd 实现数据流收集  +Graylog分析

```
softflowd -v 10 -i enp3s0 -t maxlife=1 -n 127.0.0.1:2055 -P udp -D
```





### 抓arp

```
tcpdump -vvv  arp -i vlan.34
```

### 抓某个mac

```
tcpdump -vvv  ether host  f0:00:00:3a:be:c5
```





